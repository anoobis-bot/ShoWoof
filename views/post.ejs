<!DOCTYPE html>
<html>
    <head>
        <title><%= data.title %></title>
        <link rel="stylesheet" type="text/css" href="/css/post_format.css"/>
        <link rel="stylesheet" type="text/css" href="/css/format.css"/>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="/js/comment.js"></script>
        <script src="/js/share.js"></script>
        <script src="/js/edit.js"></script>
        <script src="/js/vote.js"></script>
    </head>
    <body>
        <%- include('partials/sticky-no-search.ejs'); %>
    
        <%- include('partials/nav_panel.ejs'); %>

        <main>
            <div class="post">
                <div class="votes">
                    <% let uvote = "upvote-not" %>
                    <% let dvote = "downvote-not"; %>

                    <% data.upvotes.forEach(user => { %>
                        <% if (user.equals(userID)) {%>
                            <% uvote = "upvote" %>
                        <% } %>
                    <% }) %>
                    <% data.downvotes.forEach(user => { %>
                        <% if (user.equals(userID)) {%>
                            <% dvote = "downvote" %>
                        <% } %>
                    <% }) %>

                   <button class="<%= uvote %>" id="upvoteID:<%=data._id%>"><img></button>
                   <div class="numberOfVotes" id="statusID<%=data._id%>"> <%= data.upvotes.length - data.downvotes.length %> </div>
                   <button class="<%= dvote %>" id="downvoteID:<%=data._id%>"><img></button>
                </div>

                <div class="contentWhole">
                    <div class="postHead">
                        <div class="firstBar">
                            <div class="username">
                                Posted by <a href="/profiles/<%=data.author%>">u/<%= data.author %></a>
                            </div>
                            <div class="datePosted"> 
                                &nbsp;<%= data.datePosted.toDateString() %>
                            </div>
                        </div>
                        <div class="caption">
                            <%= data.title %>
                        </div>
                    </div>
                    <div class="content">
                        <% if (data.image_url != '') { %>
                            <!-- Show only image content -->
                            <img src="<%= data.image_url %>">
                        <% } else if (data.text_content != '') { %>
                            <!-- Show only text content -->
                            <p><%= data.text_content %></p>
                        <% } %>
                        
                    </div>
                    <div class="postToolBar">
                        <!-- <img src="/images/post_elements/comment.png">
                        <a href="#commentSection">Comments<a>&nbsp;
                        <img src="/images/post_elements/share.png">
                        <a>Share</a> -->
                        <img src="/images/post_elements/comment.png">
                        <a href="#commentSection">Comments</a>&nbsp;
                        <div id="copyLink">
                        <img src="/images/post_elements/share.png">
                        Share</div>
                        &nbsp;
                        <% if(data.author == user){ %>
                            <img src="/images/post_elements/output-onlinepngtools.png" class="action-icon">
                            &nbsp;
                            <a href="/editPost/<%=data._id%>">Edit</a>
                        <%  } %>

                    </div>
                    <br>
                    <div class="userComment">
                        <div class="commentLabel">
                            <div>Comment as</div>&nbsp;<div class="commentUsername">u/<%= user %></div>
                        </div>
                        <form action="/posts/<%=data._id%>" class="com__form"method="POST">
                            <textarea placeholder="Bark!" class="textarea" id="inputComment" name="comTerm"></textarea>
                            <div class="userCommentCommands">
                                <button type="submit" class="commentButton" id="postComment">Comment</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!------------------->
            <div class="comments" id="commentSection">
                <% data.Comments.forEach(comments => { %>
                    <% if (comments.comment != "") {%>
                    <div class="editComment">
                    <div class="commentBase" id="comment-1">
                        <div class="commenterImg"></div>
                        <div class="commentDetails">
                            <div class="commenterDetails">
                                <div class="commenterUser"><%= comments.commentAuthor %></div>
                                <div class="commentDate"><%= comments.commentDate.toDateString() %></div>
                            </div>
                            <div class="commentText"><%= comments.comment %></div>
                            <div class="commentCommandBar">
                                <div class="commentVote">
                                    <div class="upvote"></div>
                                    &nbsp;
                                    <div class="commentToolText"><%= comments.commentUpvotes %></div>
                                    &nbsp;
                                    <div class="downvote"></div>
                                </div>
                                <div class="commentReply">
                                    <!-- <img src="/images/post_elements/comment.png">
                                    <div class="commentToolText">Reply</div> -->
                                    <button class="commentToolText" id="replyComment">
                                        <img src="/images/post_elements/comment.png"> Reply
                                        <!-- <div class="commentToolText">Edit</div> -->
                                    </button>
                                </div>
                                <% if (comments.commentAuthor==user){%>
                                <div class="commentEdit">
                                    <button class="commentToolText" id="editComment:<%= comments._id %>" data-postid="<%= comments._id %>">
                                        <img src="/images/post_elements/output-onlinepngtools.png"> Edit
                                    </button>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div id="visibility-<%= comments._id %>">
                        <form action="/posts/<%= data._id %>/Comments/<%= comments._id %>/edit" class="com__form" method="POST">
                            <textarea placeholder="Bark!" class="textarea" id="editInputComment" name="editTerm"></textarea>
                            <div class="userCommentCommands">
                                <button type="submit" class="commentButton" id="editPostComment">Comment</button>
                            </div>
                        </form>
                        <form action="/posts/<%= data._id %>/comments/<%= comments._id %>/delete" method="POST">
                            <input type="hidden" name="_method" value="DELETE">
                            <button type="submit">Delete Comment</button>
                        </form>
                    </div>
                    </div> 
                    <% } %>
               <% }); %>
            </div>
        </main>
    </body>
</html>